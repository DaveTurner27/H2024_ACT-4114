---
output:
  pdf_document:
    fig_caption: yes
    includes:
      before_body: TP-title.tex
      in_header: preamble-latex.tex
---

\centering

\clearpage

\tableofcontents

```{=tex}
\justify  
\clearpage
```
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r paquetages, message=FALSE, eval=TRUE, include=FALSE, echo = FALSE}
### Liste des paquetages
liste.paquetage <- c("ggplot2", "dplyr", "CASdatasets", "knitr", "tidyverse", "FactoMineR", "DT", "factoextra", "plotly", "reshape2")

### On installe les paquetages de la liste qu'on a pas déjà
inst <- liste.paquetage %in% installed.packages()
if(length(liste.paquetage[!inst]) > 0) install.packages(liste.paquetage[!inst])

lapply(liste.paquetage, require, character.only = TRUE)

# Importation des données
data(pg15training)
data.analyse <- pg15training[-c(1:21), ]
```

# Introduction

L'objectif final de ce travail est de modéliser la fréquence des réclamations de la couverture de responsabilité civile (dommages matériels) en assurance automobile pour un portefeuille français. Pour le risque $j$, le nombre de réclamations sera noter par $N_j$. Pour procéder à la modélisation, on utilise les caractéristiques disponibles dans notre jeux de données. On notera, pour le risque $j$, le vecteur de variables explicatives par $X_j$. On tiendra aussi en compte l'exposition au risque dans notre modèle. Cette dernière se présente sous la forme de nombre de jours à risque avec un maximum de 1 an (365 jours). Cette variable sera transformer par une division de 365 afin d'obtenir une proportion d'année couverte. On notera l'exposition du risque $j$ par $t_j$. Dans le tableau de données original on retrouve :

-   la variable de fréquence $N$ sous le nom `Numtppd` ;

-   la variable d'exposition $365 t$ (version nombre de jours) sous le nom `Exppdays`.

En ce qui concerne le jeu de données, il est disponible directement en `R` dans le paquetage `CASdatasets`. Plus précisément c'est le jeux de données `pg15training`. Les données ont été utilisées par l'institut française des actuaires dans un concours/jeux de tarification. Elles proviennent d'assureurs automobile privées inconnus. La matrice contient 2 ans d'observations (2009 et 2010) avec 50 000 observations dans chacune de ces deux années. Voici quelques informations pertinentes avant de débuter l'analyse :

1.  l'âge minimal pour conduire en France est de 18 ans ;

2.  la couverture étudiée est obligatoire ;

3.  certaines variables catégorielles contiennent des groupes dont la signification demeure non spécifiée pour des raisons de confidentialité.

Pour plus d'information sur les données il est possible d'aller voir la documentation sur CRAN ou bien simplement de faire la commande suivante en `R` : `help(pg15training)`.

# Analyse exploratoire des données

Cette section est dédié à la détection erreurs ou anomalies dans notre jeux de données ainsi qu'à l'approche adopté pour la correction de ces erreurs. On regarde également les grandes lignes de l'analyse préliminaire effectuée.

## Doublons

D'abord, on remarque que certaines polices sont présentes en double dans le jeux de données. En fait, il s'agit des 21 premières lignes qui sont en surplus. Ces premières lignes sont exactement comme leur doublure à l'exception qu'aucun montant de réclamation (`Indtppd`) n'a été enregistré. La correction est assez directe, on retire simplement les 21 premières lignes et on retrouve maintenant un nombre exact de 100 000 observations tel que documenté dans la rubrique d'aide en `R`. On présente dans le tableau 1 ci-dessous un exemple de doublon avec la police numéro 200114978 (la première ligne).

```{r echo=FALSE}

id_doublon <- pg15training[1, "PolNum"]
table_data <- pg15training[pg15training$PolNum %in% id_doublon, c(1, 17, 19)]
table_data$Ligne <- row.names(table_data)

kable(
    table_data[, c(4, 1, 2, 3)], format = "markdown",
    caption = "Exemple de doublon",
    row.names = FALSE, label = "tableau1"
)

```

## Variable endogène

## Variables exogènes

Pour commercer, les variables suivantes ne doivent pas être utilisées pour modéliser la fréquence d'accident de la couverture étudiée (`Numtppd`) :

-   `Polnum` (le numéro de police n'a pas d'impact sur le nombre d'accidents)

-   `Numtpbi` (cette variable serait inconnue lors d'une prédiction)

-   `Indtppd` (cette variable serait inconnue lors d'une prédiction)

-   `Indtpbi` (cette variable serait inconnue lors d'une prédiction)

-   `CalYear` (on doit pouvoir faire des prédiction sur d'autres années que 2009 et 2010)

On regarde maintenant les variables exogènes et leur lien avec la variable endogène. Pour certaines variables, la moyenne de réclamations semblent être lié linéairement lié avec la dite variable.

**AGE**

Le nombre moyens d'accidents par `Age` ne semble pas linéairement lié avec l'age comme on peut le voir dans la figure 1. La technique boxcox suggère d'applique la transformation racine quatrième à l'age pour rendre la relation plus linéaire. On observe dans le graphique 2 que cette transformation rend le lien légèrement plus linéaire, c'est donc une considération à prendre en compte lors de la construction de GLM.

```{r echo=FALSE}
plot_moy_var <- function(var, xlabel="", ylabel="", mainlabel="", niv_conf=0.9,
                         moy_var="Numtppd", plotly=TRUE, color="darkblue", size=0.75){
    
    # Création du df moyenne / écart type par groupe
    moy_par_var <- data.analyse %>%
        group_by(across(all_of(var))) %>%
        summarise(
            Count = n(),
            Moyenne = mean(.data[[moy_var]]),
            dev_std = sd(.data[[moy_var]])
        )
    
    # IC par TCL
    moy_par_var$low_ic <- moy_par_var$Moyenne + qnorm((1-niv_conf)/2)*moy_par_var$dev_std/sqrt(moy_par_var$Count)
    moy_par_var$upp_ic <- moy_par_var$Moyenne + qnorm((1+niv_conf)/2)*moy_par_var$dev_std/sqrt(moy_par_var$Count)
    
    # Graphique ggplot
    p <- ggplot(moy_par_var) + geom_point(aes_string(x = var, y = "Moyenne"), col=color, size=2) +
        geom_errorbar(aes_string(x = var, ymin = "low_ic", ymax = "upp_ic"), width=size) +
        labs(title = mainlabel, y = ylabel, x = xlabel) +
        theme_light() +
        theme(
    plot.title = element_text(size = 20, face = "bold", margin = margin(b = 20)),
    axis.title = element_text(size = 15, face = "bold", margin = margin(l = 20)),
  )
    
    # Plotly
    if(plotly)
        ggplotly(p)
    else
        p
}
```

```{r Age, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Moyenne de réclamation par age", fig.width=10, fig.height=6}
plot_moy_var("Age", plotly = FALSE, xlabel = "Age", "Moyenne de réclamation (Numtppd)", mainlabel = "Moyenne de réclamation par age avec un IC approximatif 90%", niv_conf = 0.9)
```

```{r Age.modif, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Moyenne de réclamation par age tranformé", fig.width=10, fig.height=6}
data.analyse$modif.age <- (data.analyse$Age)^(1/4)
plot_moy_var("modif.age", plotly = FALSE, xlabel = "(Age)^(1/4)", "Moyenne de réclamation (Numtppd)", mainlabel = "Moyenne de réclamation par age modifié avec un IC approximatif 90%", niv_conf = 0.9, size = 0.01)
```

**Bonus**

La variable `Bonus` semble présenter un lien linéaire, mais 0 lien avec age

```{r Bonus, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Moyenne de réclamation par Bonus", fig.width=10, fig.height=6}
plot_moy_var("Bonus", plotly = FALSE, size = 2, niv_conf = 0.9)
```

**Lien linéaire**

```{r}
plot_moy_var("Group1", plotly = FALSE, size = 0.7, niv_conf = 0.9)
```

# Traitement des valeurs manquantes

bof

# Analyse en composantes principales

# Création de nouvelles variables explicatives

# Classification hiérarchique

# Algorithme des k-moyennes

# Conclusion

# Bibliographie

# Annexe

## Description du jeu de données

Comme sur le forum, mais sans fautes d'orthographes.

## Déclaration de l’utilisation de l’intelligence artificielle

générative

Il faut insérer la déclaration complétée ici.
